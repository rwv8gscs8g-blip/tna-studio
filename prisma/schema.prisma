generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AdminCertificate {
  id                                    String    @id @default(cuid())
  userId                                String    @unique
  certificateHash                       String
  certificateEncrypted                  String
  serialNumber                          String
  issuer                                String
  validFrom                             DateTime
  validUntil                            DateTime
  isActive                              Boolean   @default(true)
  lastUsedAt                            DateTime?
  createdBy                             String
  createdAt                             DateTime  @default(now())
  updatedAt                             DateTime  @updatedAt
  User_AdminCertificate_createdByToUser User      @relation("AdminCertificate_createdByToUser", fields: [createdBy], references: [id])
  User_AdminCertificate_userIdToUser    User      @relation("AdminCertificate_userIdToUser", fields: [userId], references: [id])

  @@index([isActive])
  @@index([serialNumber])
  @@index([userId])
  @@index([validUntil])
}

model AdminMessage {
  id           String   @id @default(cuid())
  type         String
  targetUserId String?
  title        String
  content      String
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  User         User?    @relation(fields: [targetUserId], references: [id])

  @@index([createdAt])
  @@index([targetUserId])
  @@index([type])
}

model AdminOperation {
  id                String   @id @default(cuid())
  userId            String
  operationType     String
  resourceType      String?
  resourceId        String?
  certificateSerial String
  signatureHash     String
  signatureData     String
  ip                String
  userAgent         String
  success           Boolean  @default(true)
  errorMessage      String?
  createdAt         DateTime @default(now())
  User              User     @relation(fields: [userId], references: [id])

  @@index([certificateSerial])
  @@index([createdAt])
  @@index([operationType])
  @@index([userId])
}

model ArquitetoSession {
  id        String   @id @default(cuid())
  userId    String
  sessionId String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation("ArquitetoSession", fields: [userId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([isActive])
  @@index([expiresAt])
}

model AppConfig {
  id                         String   @id @default("singleton")
  authorizedCodeVersion      String?
  authorizedSchemaVersion    String?
  authorizedMigrationVersion String?
  productionWriteEnabled     Boolean  @default(true)
  preStartValidationEnabled  Boolean  @default(true)
  updatedAt                  DateTime @updatedAt
  updatedBy                  String?
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  actorId   String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([actorId])
  @@index([createdAt])
}

model Gallery {
  id             String          @id @default(cuid())
  title          String
  description    String?
  userId         String?
  isPrivate      Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  ownerCpf       String?
  ownerPassport  String?
  sessionDate    DateTime?
  syncLink       String?
  syncPassword   String?
  termDocumentId String?         @unique
  User           User?           @relation(fields: [userId], references: [id])
  GalleryAccess  GalleryAccess[]
  Photo          Photo[]
  TermDocument   TermDocument?

  @@index([ownerCpf])
  @@index([ownerPassport])
  @@index([sessionDate])
  @@index([userId])
  @@index([deletedAt])
}

model GalleryAccess {
  id          String   @id @default(cuid())
  galleryId   String
  granteeId   String
  canDownload Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  Gallery     Gallery  @relation(fields: [galleryId], references: [id])
  User        User     @relation(fields: [granteeId], references: [id])

  @@unique([galleryId, granteeId])
  @@index([granteeId])
  @@index([deletedAt])
}

model ImageRights {
  id             String    @id @default(cuid())
  photoId        String    @unique
  ownerId        String
  hasUsageRights Boolean   @default(false)
  allowedRoles   Role[]
  allowedUsers   String[]
  expiresAt      DateTime?
  metadata       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  User           User      @relation(fields: [ownerId], references: [id])
  Photo          Photo     @relation(fields: [photoId], references: [id])

  @@index([ownerId])
  @@index([deletedAt])
}

model OtpToken {
  id        String   @id @default(cuid())
  phone     String
  cpf       String?
  passport  String?
  email     String
  otp       String
  ip        String
  userAgent String
  expiresAt DateTime
  verified  Boolean  @default(false)
  userId    String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([expiresAt])
  @@index([phone, otp])
  @@index([userId])
}

model Photo {
  id          String       @id @default(cuid())
  key         String       @unique
  title       String?
  mimeType    String
  bytes       Int
  galleryId   String
  isSensitive Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  hash        String?
  ImageRights ImageRights?
  Gallery     Gallery      @relation(fields: [galleryId], references: [id])

  @@index([galleryId])
  @@index([hash])
  @@index([key])
  @@index([deletedAt])
}

model TermDocument {
  id         String   @id @default(cuid())
  galleryId  String   @unique
  key        String
  mimeType   String
  bytes      Int
  uploadedBy String
  createdAt  DateTime @default(now())
  deletedAt  DateTime?
  Gallery    Gallery  @relation(fields: [galleryId], references: [id])

  @@index([galleryId])
  @@index([uploadedBy])
  @@index([deletedAt])
}

enum EnsaioStatus {
  DRAFT
  PUBLISHED
}

model Ensaio {
  id               String          @id @default(cuid())
  title            String
  slug             String          @unique
  description      String?
  shootDate        DateTime? // Data do ensaio (obrigatório na criação, usado para ordenação)
  status           EnsaioStatus    @default(PUBLISHED) // "DRAFT" | "PUBLISHED"
  createdById      String
  subjectCpf       String // CPF do MODELO ou CLIENTE associado ao ensaio (obrigatório, apenas MODELO ou CLIENTE)
  coverImageKey    String? // Chave R2 da foto de capa (ex: ensaio-123/cover.jpg) - nunca URL pública
  termPdfKey       String? // Chave R2 do PDF do termo (ex: ensaio-123/term.pdf) - nunca URL pública
  syncFolderUrl    String? // URL do link do Sync.com (MUITO SENSÍVEL - apenas para ARQUITETO/ADMIN via API protegida)
  d4signDocumentId String? // ID do documento no D4Sign (para integração futura) - nullable
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  createdBy        User            @relation("EnsaioCreatedBy", fields: [createdById], references: [id])
  subject          User            @relation("EnsaiosPorCpf", fields: [subjectCpf], references: [cpf])
  photos           EnsaioPhoto[] // Lista das melhores fotos do ensaio (até 30 fotos)
  projetos         EnsaioProjeto[] // Relação muitos-para-muitos com Projeto
  produtos         EnsaioProduto[] // Relação muitos-para-muitos com Produto

  @@index([createdById])
  @@index([subjectCpf])
  @@index([slug])
  @@index([status])
  @@index([shootDate])
  @@index([deletedAt])
}

model EnsaioPhoto {
  id         String   @id @default(cuid())
  ensaioId   String
  ensaio     Ensaio   @relation(fields: [ensaioId], references: [id])
  storageKey String // Chave R2 da foto (ex: ensaio-123/photo-01.jpg) - nunca URL pública, sempre gerar signed URL
  sortOrder  Int      @default(0) // Ordem de exibição (0 = primeiro, usado para ordenar as melhores fotos)
  createdAt  DateTime @default(now())
  deletedAt  DateTime?

  @@index([ensaioId])
  @@index([sortOrder])
  @@index([storageKey])
  @@index([deletedAt])
}

model Projeto {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  description String?
  active      Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?
  ensaios     EnsaioProjeto[] // Relação muitos-para-muitos com Ensaio

  @@index([slug])
  @@index([active])
  @@index([deletedAt])
}

model EnsaioProjeto {
  id        String   @id @default(cuid())
  ensaioId  String
  projetoId String
  ensaio    Ensaio   @relation(fields: [ensaioId], references: [id])
  projeto   Projeto  @relation(fields: [projetoId], references: [id])
  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([ensaioId, projetoId])
  @@index([ensaioId])
  @@index([projetoId])
  @@index([deletedAt])
}

model Produto {
  id            String           @id @default(cuid())
  nome          String           @unique
  descricao     String?
  preco         Float
  categoria     String? // Ex: "Pacote", "Promoção", "TFP"
  isPromocao    Boolean          @default(false) // Para destacar promoções
  isTfp         Boolean          @default(false) // Para destacar TFP/Permuta
  coverImageKey String? // Chave R2 da foto principal do produto
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  deletedAt     DateTime?
  ensaios       EnsaioProduto[] // Relação muitos-para-muitos com Ensaio
  photos        ProdutoPhoto[] // Mini galeria do produto (5 fotos máx)
  intencoes     IntencaoCompra[] // Intenções de compra das modelos

  @@index([categoria])
  @@index([isPromocao])
  @@index([isTfp])
  @@index([deletedAt])
}

model ProdutoPhoto {
  id         String   @id @default(cuid())
  produtoId  String
  produto    Produto  @relation(fields: [produtoId], references: [id])
  storageKey String // Chave R2 da foto (ex: produto-123/photo-01.jpg) - nunca URL pública
  sortOrder  Int      @default(0) // Ordem de exibição (0 = primeiro)
  createdAt  DateTime @default(now())
  deletedAt  DateTime?

  @@index([produtoId])
  @@index([sortOrder])
  @@index([deletedAt])
}

model EnsaioProduto {
  id        String   @id @default(cuid())
  ensaioId  String
  produtoId String
  ensaio    Ensaio   @relation(fields: [ensaioId], references: [id])
  produto   Produto  @relation(fields: [produtoId], references: [id])
  createdAt DateTime @default(now())
  deletedAt DateTime?

  @@unique([ensaioId, produtoId])
  @@index([ensaioId])
  @@index([produtoId])
  @@index([deletedAt])
}

model IntencaoCompra {
  id        String   @id @default(cuid())
  modeloId  String
  produtoId String
  status    String   @default("PENDENTE") // "PENDENTE" | "APROVADA" | "REJEITADA" | "CONCLUIDA"
  produto   Produto  @relation(fields: [produtoId], references: [id])
  modelo    User     @relation("IntencoesCompra", fields: [modeloId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([modeloId])
  @@index([produtoId])
  @@index([status])
  @@index([deletedAt])
}

model User {
  id                                                String             @id @default(cuid())
  email                                             String             @unique // OBRIGATÓRIO
  name                                              String?
  passwordHash                                      String
  role                                              Role               @default(MODELO)
  createdAt                                         DateTime           @default(now())
  updatedAt                                         DateTime           @updatedAt
  deletedAt                                         DateTime?
  acceptedAt                                        DateTime?
  address                                           String?
  adminMessage                                      String?
  birthDate                                         DateTime? // OBRIGATÓRIO (idade >= 18)
  city                                              String?
  country                                           String?
  cpf                                               String?            @unique // OBRIGATÓRIO (chave para galerias)
  gdprAccepted                                      Boolean            @default(false)
  lgpdAccepted                                      Boolean            @default(false)
  passport                                          String?            @unique
  personalDescription                               String?
  phone                                             String? // OBRIGATÓRIO (formato E.164)
  profileImage                                      String?
  state                                             String?
  termsAccepted                                     Boolean            @default(false)
  twoFactorEnabled                                  Boolean            @default(false)
  zipCode                                           String?
  AdminCertificate_AdminCertificate_createdByToUser AdminCertificate[] @relation("AdminCertificate_createdByToUser")
  AdminCertificate_AdminCertificate_userIdToUser    AdminCertificate?  @relation("AdminCertificate_userIdToUser")
  AdminMessage                                      AdminMessage[]
  AdminOperation                                    AdminOperation[]
  ArquitetoSession                                  ArquitetoSession[] @relation("ArquitetoSession")
  Ensaio                                            Ensaio[]           @relation("EnsaioCreatedBy")
  EnsaiosPorCpf                                     Ensaio[]           @relation("EnsaiosPorCpf")
  Gallery                                           Gallery[]
  GalleryAccess                                     GalleryAccess[]
  ImageRights                                       ImageRights[]
  OtpToken                                          OtpToken[]
  IntencoesCompra                                   IntencaoCompra[]   @relation("IntencoesCompra")

  @@index([email])
  @@index([phone])
  @@index([deletedAt])
}

enum Role {
  ARQUITETO
  ADMIN
  MODELO
  CLIENTE
  SUPERADMIN
}
