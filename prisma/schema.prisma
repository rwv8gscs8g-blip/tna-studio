generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model AdminCertificate {
  id                                    String    @id @default(cuid())
  userId                                String    @unique
  certificateHash                       String
  certificateEncrypted                  String
  serialNumber                          String
  issuer                                String
  validFrom                             DateTime
  validUntil                            DateTime
  isActive                              Boolean   @default(true)
  lastUsedAt                            DateTime?
  createdBy                             String
  createdAt                             DateTime  @default(now())
  updatedAt                             DateTime  @updatedAt
  User_AdminCertificate_createdByToUser User      @relation("AdminCertificate_createdByToUser", fields: [createdBy], references: [id])
  User_AdminCertificate_userIdToUser    User      @relation("AdminCertificate_userIdToUser", fields: [userId], references: [id])

  @@index([isActive])
  @@index([serialNumber])
  @@index([userId])
  @@index([validUntil])
}

model AdminMessage {
  id           String   @id @default(cuid())
  type         String
  targetUserId String?
  title        String
  content      String
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  User         User?    @relation(fields: [targetUserId], references: [id])

  @@index([createdAt])
  @@index([targetUserId])
  @@index([type])
}

model AdminOperation {
  id                String   @id @default(cuid())
  userId            String
  operationType     String
  resourceType      String?
  resourceId        String?
  certificateSerial String
  signatureHash     String
  signatureData     String
  ip                String
  userAgent         String
  success           Boolean  @default(true)
  errorMessage      String?
  createdAt         DateTime @default(now())
  User              User     @relation(fields: [userId], references: [id])

  @@index([certificateSerial])
  @@index([createdAt])
  @@index([operationType])
  @@index([userId])
}

model ArquitetoSession {
  id        String   @id @default(cuid())
  userId    String
  sessionId String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation("ArquitetoSession", fields: [userId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([isActive])
  @@index([expiresAt])
}

model AppConfig {
  id                         String   @id @default("singleton")
  authorizedCodeVersion      String?
  authorizedSchemaVersion    String?
  authorizedMigrationVersion String?
  productionWriteEnabled     Boolean  @default(true)
  preStartValidationEnabled  Boolean  @default(true)
  updatedAt                  DateTime @updatedAt
  updatedBy                  String?
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String
  actorId   String?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([actorId])
  @@index([createdAt])
}

model Gallery {
  id             String          @id @default(cuid())
  title          String
  description    String?
  userId         String?
  isPrivate      Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?
  ownerCpf       String?
  ownerPassport  String?
  sessionDate    DateTime?
  syncLink       String?
  syncPassword   String?
  termDocumentId String?         @unique
  User           User?           @relation(fields: [userId], references: [id])
  GalleryAccess  GalleryAccess[]
  Photo          Photo[]
  TermDocument   TermDocument?

  @@index([ownerCpf])
  @@index([ownerPassport])
  @@index([sessionDate])
  @@index([userId])
  @@index([deletedAt])
}

model GalleryAccess {
  id          String    @id @default(cuid())
  galleryId   String
  granteeId   String
  canDownload Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  Gallery     Gallery   @relation(fields: [galleryId], references: [id])
  User        User      @relation(fields: [granteeId], references: [id])

  @@unique([galleryId, granteeId])
  @@index([granteeId])
  @@index([deletedAt])
}

model ImageRights {
  id             String    @id @default(cuid())
  photoId        String    @unique
  ownerId        String
  hasUsageRights Boolean   @default(false)
  allowedRoles   Role[]
  allowedUsers   String[]
  expiresAt      DateTime?
  metadata       String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  User           User      @relation(fields: [ownerId], references: [id])
  Photo          Photo     @relation(fields: [photoId], references: [id])

  @@index([ownerId])
  @@index([deletedAt])
}

model OtpToken {
  id        String   @id @default(cuid())
  phone     String
  cpf       String?
  passport  String?
  email     String
  otp       String
  ip        String
  userAgent String
  expiresAt DateTime
  verified  Boolean  @default(false)
  userId    String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([expiresAt])
  @@index([phone, otp])
  @@index([userId])
}

model Photo {
  id          String       @id @default(cuid())
  key         String       @unique
  title       String?
  mimeType    String
  bytes       Int
  galleryId   String
  isSensitive Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  hash        String?
  ImageRights ImageRights?
  Gallery     Gallery      @relation(fields: [galleryId], references: [id])

  @@index([galleryId])
  @@index([hash])
  @@index([key])
  @@index([deletedAt])
}

model TermDocument {
  id         String    @id @default(cuid())
  galleryId  String    @unique
  key        String
  mimeType   String
  bytes      Int
  uploadedBy String
  createdAt  DateTime  @default(now())
  deletedAt  DateTime?
  Gallery    Gallery   @relation(fields: [galleryId], references: [id])

  @@index([galleryId])
  @@index([uploadedBy])
  @@index([deletedAt])
}

model Ensaio {
  id               String          @id @default(cuid())
  title            String
  slug             String          @unique
  description      String?
  shootDate        DateTime?
  status           EnsaioStatus    @default(PUBLISHED)
  createdById      String
  subjectCpf       String
  coverImageKey    String?
  termPdfKey       String?
  syncFolderUrl    String?
  d4signDocumentId String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  deletedAt        DateTime?
  createdBy        User            @relation("EnsaioCreatedBy", fields: [createdById], references: [id])
  subject          User            @relation("EnsaiosPorCpf", fields: [subjectCpf], references: [cpf])
  photos           EnsaioPhoto[]
  produtos         EnsaioProduto[]
  projetos         EnsaioProjeto[]

  @@index([createdById])
  @@index([subjectCpf])
  @@index([slug])
  @@index([status])
  @@index([shootDate])
  @@index([deletedAt])
}

model EnsaioPhoto {
  id         String    @id @default(cuid())
  ensaioId   String
  storageKey String
  sortOrder  Int       @default(0)
  createdAt  DateTime  @default(now())
  deletedAt  DateTime?
  ensaio     Ensaio    @relation(fields: [ensaioId], references: [id])

  @@index([ensaioId])
  @@index([sortOrder])
  @@index([storageKey])
  @@index([deletedAt])
}

model Projeto {
  id              String          @id @default(cuid())
  name            String
  slug            String          @unique
  description     String?
  fullDescription String?
  rules           String?
  active          Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  deletedAt       DateTime?
  ensaios         EnsaioProjeto[]

  @@index([slug])
  @@index([active])
  @@index([deletedAt])
}

model EnsaioProjeto {
  id        String    @id @default(cuid())
  ensaioId  String
  projetoId String
  createdAt DateTime  @default(now())
  deletedAt DateTime?
  ensaio    Ensaio    @relation(fields: [ensaioId], references: [id])
  projeto   Projeto   @relation(fields: [projetoId], references: [id])

  @@unique([ensaioId, projetoId])
  @@index([ensaioId])
  @@index([projetoId])
  @@index([deletedAt])
}

model Produto {
  id               String           @id @default(cuid())
  slug             String           @unique
  nome             String
  shortDescription String?
  fullDescription  String?
  precoEuro        Float?
  categoria        String?
  isActive         Boolean          @default(true)
  coverImageKey    String?
  displayOrder     Int              @default(0)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  ensaios          EnsaioProduto[]
  intencoes        IntencaoCompra[]
  photos           ProdutoPhoto[]

  @@index([slug])
  @@index([isActive])
  @@index([categoria])
  @@index([displayOrder])
  @@index([deletedAt])
}

model ProdutoPhoto {
  id         String    @id @default(cuid())
  produtoId  String
  storageKey String
  sortOrder  Int       @default(0)
  createdAt  DateTime  @default(now())
  deletedAt  DateTime?
  produto    Produto   @relation(fields: [produtoId], references: [id])

  @@index([produtoId])
  @@index([sortOrder])
  @@index([deletedAt])
}

model EnsaioProduto {
  id        String    @id @default(cuid())
  ensaioId  String
  produtoId String
  createdAt DateTime  @default(now())
  deletedAt DateTime?
  ensaio    Ensaio    @relation(fields: [ensaioId], references: [id])
  produto   Produto   @relation(fields: [produtoId], references: [id])

  @@unique([ensaioId, produtoId])
  @@index([ensaioId])
  @@index([produtoId])
  @@index([deletedAt])
}

model IntencaoCompra {
  id        String    @id @default(cuid())
  modeloId  String
  produtoId String
  status    String    @default("PENDENTE")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  modelo    User      @relation("IntencoesCompra", fields: [modeloId], references: [id])
  produto   Produto   @relation(fields: [produtoId], references: [id])

  @@index([modeloId])
  @@index([produtoId])
  @@index([status])
  @@index([deletedAt])
}

model User {
  id                                                String             @id @default(cuid())
  email                                             String             @unique
  name                                              String?
  passwordHash                                      String
  role                                              Role               @default(MODELO)
  createdAt                                         DateTime           @default(now())
  updatedAt                                         DateTime           @updatedAt
  deletedAt                                         DateTime?
  acceptedAt                                        DateTime?
  address                                           String?
  adminMessage                                      String?
  birthDate                                         DateTime?
  city                                              String?
  country                                           String?
  cpf                                               String?            @unique
  gdprAccepted                                      Boolean            @default(false)
  lgpdAccepted                                      Boolean            @default(false)
  passport                                          String?            @unique
  personalDescription                               String?
  phone                                             String?
  profileImage                                      String?
  state                                             String?
  termsAccepted                                     Boolean            @default(false)
  twoFactorEnabled                                  Boolean            @default(false)
  zipCode                                           String?
  AdminCertificate_AdminCertificate_createdByToUser AdminCertificate[] @relation("AdminCertificate_createdByToUser")
  AdminCertificate_AdminCertificate_userIdToUser    AdminCertificate?  @relation("AdminCertificate_userIdToUser")
  AdminMessage                                      AdminMessage[]
  AdminOperation                                    AdminOperation[]
  ArquitetoSession                                  ArquitetoSession[] @relation("ArquitetoSession")
  Ensaio                                            Ensaio[]           @relation("EnsaioCreatedBy")
  EnsaiosPorCpf                                     Ensaio[]           @relation("EnsaiosPorCpf")
  Gallery                                           Gallery[]
  GalleryAccess                                     GalleryAccess[]
  ImageRights                                       ImageRights[]
  IntencoesCompra                                   IntencaoCompra[]   @relation("IntencoesCompra")
  OtpToken                                          OtpToken[]

  @@index([email])
  @@index([phone])
  @@index([deletedAt])
}

enum EnsaioStatus {
  DRAFT
  PUBLISHED
}

enum Role {
  ARQUITETO
  ADMIN
  MODELO
  CLIENTE
  SUPERADMIN
}
